{% extends 'base.html' %}
{% load humanize bootstrap5 %}

{% block title %}
  Detalhes da Venda #{{ sale.id }}
{% endblock %}

{% block content %}
  <div class="container mt-4">
    <h2>Detalhes da Venda #{{ sale.id }}</h2>
    <hr />

    <p>
      <strong>Data:</strong> {{ sale.sale_date|date:'d/m/Y H:i' }}
    </p>
    <p>
      <strong>Comprador:</strong> {{ sale.buyer.username }}
    </p>

    <div class="row g-4">
      <div class="col-md-7">
        <div class="card">
          <div class="card-header">
            <h5>Itens</h5>
          </div>
          <div class="card-body p-0">
            <table class="table mb-0">
              <thead>
                <tr>
                  <th>Produto</th>
                  <th>Qtd.</th>
                  <th>Unitário</th>
                  <th>Subtotal</th>
                </tr>
              </thead>
              <tbody>
                {% for item in sale.items.all %}
                  <tr>
                    <td>{{ item.product.name }}</td>
                    <td>{{ item.quantity }}</td>
                    <td>R$ {{ item.unit_price|floatformat:2|intcomma }}</td>
                    <td>R$ {{ item.subtotal|floatformat:2|intcomma }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <div class="card-footer d-flex justify-content-between">
            <strong>Total:</strong>
            <span>R$ {{ sale.total_price|floatformat:2|intcomma }}</span>
          </div>
        </div>
      </div>
      <div class="col-md-5">
        <div class="card mb-3">
          <div class="card-header">
            <h5>Endereço</h5>
          </div>
          <div class="card-body">
            <p>
              {{ sale.cep }}<br />
              {{ sale.street }}, {{ sale.number }}<br />
              Bairro {{ sale.neighborhood }}<br />
              {{ sale.city }}/{{ sale.state }}<br />
              <small class="text-muted">Complemento: {{ sale.complement|default:'—' }}</small>
            </p>
          </div>
        </div>
        <div class="card">
          <div class="card-header">
            <h5>Totais</h5>
          </div>
          <div class="card-body">
            <p>
              <strong>Total da Venda:</strong> R$ {{ sale.total_price|floatformat:2|intcomma }}
            </p>
          </div>
        </div>
      </div>
    </div>

     <div class="mt-4">
      <a href="{% url 'sales:sale_edit' sale.id %}" class="btn btn-primary">Editar Venda</a>

      <button type="button"
              class="btn btn-danger"
              data-bs-toggle="modal"
              data-bs-target="#confirmDeleteModal">
        Excluir Venda
      </button>

      <a href="{% url 'sales:sales_list' %}" class="btn btn-secondary">Voltar à lista</a>
    </div>
  </div>

  <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmDeleteLabel">Confirmar Exclusão</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          Tem certeza que deseja excluir a venda <strong>#{{ sale.id }}</strong>?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <form method="post" action="{% url 'sales:sale_delete' sale.id %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger">Excluir</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  {% for message in messages %}
    {% if 'show-update-modal' in message.tags %}
      <div class="modal fade" id="updateSuccessModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header border-0">
              <h5 class="modal-title">Sucesso!</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
              <i class="bi bi-check-circle-fill text-success" style="font-size:3rem;"></i>
              <p class="mt-3 fs-5">{{ message }}</p>
            </div>
            <div class="modal-footer border-0 justify-content-center">
              <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Ok</button>
            </div>
          </div>
        </div>
      </div>
      <script>
        document.addEventListener('DOMContentLoaded', function() {
          new bootstrap.Modal(document.getElementById('updateSuccessModal')).show();
        });
      </script>
    {% endif %}
  {% endfor %}
{% endblock %}
